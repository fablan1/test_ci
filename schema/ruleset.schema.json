{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/schemas/ruleset.schema.json",
  "title": "LLM Readiness Ruleset",
  "type": "object",
  "additionalProperties": false,
  "required": ["id", "version", "language", "weights", "checks"],
  "properties": {
    "id": { "type": "string", "minLength": 1 },
    "version": { "type": "integer", "minimum": 1 },
    "language": { "type": "string", "minLength": 2, "maxLength": 10 },

    "weights": {
      "type": "object",
      "additionalProperties": false,
      "required": ["structure", "answerability", "neutrality", "topical_focus", "entity_binding"],
      "properties": {
        "structure": { "type": "number", "minimum": 0, "maximum": 1 },
        "answerability": { "type": "number", "minimum": 0, "maximum": 1 },
        "neutrality": { "type": "number", "minimum": 0, "maximum": 1 },
        "topical_focus": { "type": "number", "minimum": 0, "maximum": 1 },
        "entity_binding": { "type": "number", "minimum": 0, "maximum": 1 }
      }
    },
   "sql": { "type": "object" },
    "checks": {
      "type": "array",
      "minItems": 1
    }
  },

  "$defs": {
    "severity": { "type": "string", "enum": ["low", "medium", "high"] },
    "dimension": {
      "type": "string",
      "enum": ["structure", "answerability", "neutrality", "topical_focus", "entity_binding"]
    },

    "then": {
      "type": "object",
      "additionalProperties": false,
      "required": ["scorePenalty", "message"],
      "properties": {
        "scorePenalty": { "type": "number", "minimum": 0 },
        "message": { "type": "string", "minLength": 1 }
      }
    },

    "countConstraint": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "min": { "type": "integer", "minimum": 0 },
        "max": { "type": "integer", "minimum": 0 },
        "equals": { "type": "integer", "minimum": 0 }
      },
      "oneOf": [
        { "required": ["equals"] },
        { "required": ["min"] },
        { "required": ["max"] },
        { "required": ["min", "max"] }
      ]
    },

    "whenHeuristic": {
      "type": "object",
      "additionalProperties": false,
      "required": ["selector"],
      "properties": {
        "selector": { "type": "string", "minLength": 1 },
        "count": { "$ref": "#/$defs/countConstraint" },
        "scope": { "type": "string", "enum": ["document", "main", "intro", "section"] }
      }
    },

    "lexiconConfig": {
      "type": "object",
      "additionalProperties": false,
      "required": ["terms"],
      "properties": {
        "terms": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string", "minLength": 1 }
        },
        "maxDensity": { "type": "number", "minimum": 0, "maximum": 1 },
        "match": { "type": "string", "enum": ["caseInsensitive", "caseSensitive"] }
      }
    },

    "llmConfig": {
      "type": "object",
      "additionalProperties": false,
      "required": ["promptRef"],
      "properties": {
        "promptRef": { "type": "string", "minLength": 1 },
        "introBlocks": { "type": "integer", "minimum": 1 },
        "responseSchemaId": { "type": "string", "minLength": 1 }
      }
    },

    "check": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "type", "dimension", "severity", "then"],
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "type": { "type": "string", "enum": ["heuristic", "lexicon", "llm"] },
        "dimension": { "$ref": "#/$defs/dimension" },
        "severity": { "$ref": "#/$defs/severity" },
        "when": { "type": "object" },
        "config": { "type": "object" },
        "then": { "$ref": "#/$defs/then" }
      },
      "allOf": [
        {
          "if": { "properties": { "type": { "const": "heuristic" } } },
          "then": {
            "required": ["when"],
            "properties": { "when": { "$ref": "#/$defs/whenHeuristic" } }
          }
        },
        {
          "if": { "properties": { "type": { "const": "lexicon" } } },
          "then": {
            "required": ["config"],
            "properties": { "config": { "$ref": "#/$defs/lexiconConfig" } }
          }
        },
        {
          "if": { "properties": { "type": { "const": "llm" } } },
          "then": {
            "required": ["config"],
            "properties": { "config": { "$ref": "#/$defs/llmConfig" } }
          }
        }
      ]
    }
  }
}
